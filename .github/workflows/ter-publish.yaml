name: TER Publish

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yaml

  ter-publish:
    name: Publish to TER
    runs-on: ubuntu-latest
    needs: ci
    if: startsWith(github.ref, 'refs/tags/')
    env:
      TYPO3_API_TOKEN: ${{ secrets.TYPO3_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl, mbstring, json, zip, curl

      - name: Install TYPO3 Tailor
        run: composer global require typo3/tailor --no-progress

      - name: Publish to TER
        run: |
          ~/.composer/vendor/bin/tailor ter:publish \
            --comment "Release version ${{ steps.version.outputs.version }}" \
            ${{ steps.version.outputs.version }}
